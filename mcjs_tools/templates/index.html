<!doctype html>
<html class="w-full h-full">
<head>
	<title>mcjs Inspector</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" type="text/css" href="/assets/style.css">
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.js"></script>
  <script defer src="/assets/htmx-1.9.6.js"></script>
</head>

<body 
	class="w-full h-full dark:bg-zinc-800 dark:text-white text-black"
	>
  {{#with model}}
		<div class="grid grid-cols-[minmax(0,auto)_1cm_1fr] inset-0 w-full h-full">
			<div
				class="grid grid-rows-[auto_1fr]"
			>
				<div class="flex flex-col p-0 cursor-default">
					<!-- Left sidebar -->

					{{#if ../failure}}
						<div class="m-2 px-4 py-2 text-white bg-zinc-900">
							<p>
								<span class="bg-rose-500 px-4 px-1"><b>Interpreter failed:</b></span>
							</p>
							{{../failure}}
						</div>
					{{/if}}

					<div class="my-1">
						<span class="
							bg-zinc-500 text-zinc-100
							dark:bg-zinc-600 dark:text-zinc-200
							font-semibold text-sm px-1 py-0.5 mx-2 uppercase
						"> Breakpoints </span>
					</div>

					<div>
						<div class="text-xs whitespace-nowrap">
							{{#each breakpoints}}
								<div class="
									px-1 cursor-pointer
									hover:bg-sky-100
									dark:bg-zinc-800 dark:hover:bg-zinc-700
								">
									{{ filename }}:{{ line }}
								</div>
							{{/each}}
						</div>
					</div>
				</div>
			</div>

			<div id="main-area-labels" class="grid stack-view-grid-rows inset-0">
				<div></div>
				<div class="sticky lowercase text-xl text-vertical dark:text-white py-2 ml-auto mr-auto">
					Code
				</div>
				<div class="sticky lowercase text-xl text-vertical text-right dark:text-white py-2 ml-auto mr-auto">
					Data
				</div>
			</div>

			<div id="main-area" class="inset-0 w-full h-full overflow-x-scroll flex">
				<!-- Main area -->
				{{#each frames}}
					<div
						id="stack-frame-{{ @index }}"
						class="grid stack-view-grid-rows min-w-fit mr-4 space-x-2 h-full
							border-l border-zinc-600 text-xs"
						x-data="{sourceVisible: false, highlight: {iidStart: null, iidEnd: null}}"
					>
						<div 
							class="flex flex-row items-center gap-2 px-2 relative"
							x-data="{ detailsVisible: false }"
						>
							<!-- Top bar, above bytecode -->
							<button 
								class="p-1 rounded-full bg-zinc-600 hover:bg-zinc-500 text-black shadow cursor-pointer
									[&.active]:bg-zinc-200"
								@click="sourceVisible = ! sourceVisible"
								x-bind:class="sourceVisible && 'active'"
								hx-get="/frames/{{ @index }}/source_preview"
								hx-target="next #source-content-{{@index}}"
								hx-swap="innerHTML show:#current:top"
								>
								JS
							</button>

							<div>
								<span class="">fn</span>
								<span class="font-mono">{{ moduleID }}.{{ functionID }}</span>
							</div>

							<!-- TODO add tooltip -->
							<div
								class="max-w-[5cm] inline-block whitespace-nowrap text-ellipsis overflow-hidden
									cursor-default"
								style="direction: rtl"
								x-on:mouseenter="detailsVisible = true"
								x-on:mouseleave="detailsVisible = false"
							>
								{{ source.filename }}
							</div>

							<div
								class="absolute rounded-md bg-slate-900 ring-2 ring-slate-700
									p-2 mt-[2.8cm] max-w-[9cm]"
								x-show="detailsVisible"
							>
								<div class="font-bold">Source file:</div>
								<div class="pl-2">{{ source.filename }}</div>
							</div>
						</div>

						<div
							id="source-content-{{@index}}"
							class="overflow-scroll min-w-[8cm] max-w-[12cm] row-span-full col-start-2 text-xs font-mono whitespace-pre"
							x-show="sourceVisible">
						</div>

						<div class='flex flex-row px-2 overflow-y-scroll border-b border-dashed border-zinc-600'>
							<div 
								class="grid grid-cols-[auto_1fr] gap-x-1 auto-rows-min justify-start
									script--highlight-mcjs-values [&>*]:whitespace-nowrap"
								onload="this.querySelector('.highlighted').scrollIntoView({ block: 'center' })"
							>
								{{#each (lookup_deep ../modules moduleID 'functions' functionID 'bytecode')}}
									<div
										class="text-right read 
										{{#if (eq @index ../iid)}} highlighted {{/if}}
										[&.highlighted]:bg-white [&.highlighted]:text-black"
										data-mcjs-value="call{{ callID }}-v{{ instrNdx }}"
									>
										<span
											class="font-mono px-2 border-white [&.highlight]:border-l-2"
											x-bind:class="{{ @index }} >= highlight.iidStart && {{ @index }} < highlight.iidEnd && 'highlight'"
										>
											{{ @index }}â¬¥ 
										</span>
									</div>
									<div>
										{{ this }}
									</div>
								{{/each}}
							</div>
						</div>

						<div class="overflow-y-scroll">
							<table>
								<tbody>
									<tr>
										<td class="text-right">this</td>
										<td></td>
										<td>{{ thisValue }}</td>
									</tr>

									{{#with values}}
										{{#each captures}}
											<tr>
												<td class="text-right">{{ name }}</td>
												<td>{{ ident }}</td>
												<td>{{ value }}</td>
											</tr>
											{{#if prev_idents}}
											<tr>
												<td colspan="3">
													{{prev_idents}}
												</td>
											</tr>
											{{/if}}
										{{/each}}


										{{#each arguments}}
											<tr>
												<td class="text-right">{{ name }}</td>
												<td>{{ ident }}</td>
												<td>{{ value }}</td>
											</tr>
											{{#if prev_idents}}
											<tr>
												<td colspan="3">
													{{prev_idents}}
												</td>
											</tr>
											{{/if}}
										{{/each}}

										{{#each registers}}
											<tr>
												<td class="text-right">{{ name }}</td>
												<td>{{ ident }}</td>
												<td>{{ value }}</td>
											</tr>
											{{#if prev_idents}}
											<tr>
												<td colspan="3">
													{{prev_idents}}
												</td>
											</tr>
											{{/if}}
										{{/each}}
									{{/with}}
								</tbody>
							</table>
						</div>
					</div>
				 {{/each}}
			</div>
		</div>
	{{/with}}
</body>


