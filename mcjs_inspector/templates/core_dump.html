{% extends "index.html" %}

{% macro column_header(text) %}
	<div class="text-xl lowercase sticky px-4 py-2">
		<span class="text-white px-1">{{text}}</span>
	</div>
{% endmacro %}

{% block content %} 
	<div id="content" class="grid grid-rows-[1cm_1fr] grid-cols-3 gap-x-2 inset-0 w-full h-full">

		{% call column_header("Code") %}
		{% call column_header("Values") %}
		{% call column_header("Stack") %}

		<div class="overflow-y-scroll text-sm">
			<table class="w-full">
				<tbody class="divide-y dark:divide-slate-600 bg-white text-slate-800 dark:bg-transparent dark:text-white cursor-default">
					{% for instr in instr_history %}
					<tr class="hover:bg-slate-100 hover:dark:bg-slate-800"> 
						<td>-</td>
						<td style="padding-left: {{ instr.left_padding }}">

							{% for part in instr.parts %}
								{% match part %}
								{% when InstrPartView::Opcode with (name) %}
									<span>{{name}}</span>

								{% when InstrPartView::Read with (vreg) %}
									<form method="POST" action="core_dump/add-watch" class="inline">
										<input type="hidden" name="call_id" value="{{instr.call_id.0}}">
										<input type="hidden" name="vreg" value="{{vreg.0}}">
										<button class='group inline-block px-1 cursor-pointer value
													[&.highlighted]:bg-sky-500
													[&.highlighted]:text-white' 
												data-mcjs-value='call{{instr.call_id.0}}-v{{vreg.0}}'
												hx-post="core_dump/add-watch" 
												hx-target="#watches"
												hx-select="#watches"
												hx-swap="outerHTML"
												> 
											r{{vreg.0}}⬥
										</button>
									</form>

								{% when InstrPartView::Write with (vreg) %}
									<div
										class='group inline-block px-1 cursor-pointer value write
											[&.highlighted]:bg-rose-800
											[&.highlighted]:text-white'
										data-mcjs-value='call{{instr.call_id.0}}-v{{vreg.0}}'>
										w{{vreg.0}}⬥
									</div>

								{% when InstrPartView::Other with (str) %}
									<span>{{str}}</span>
								{% endmatch %}
							{% endfor %}

						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>

		{% match vm_result.core_dump %}
		{% when Some with (core_dump) %}

			<div id="watches" class="overflow-y-scroll inset-0">
				<div class="">
					{% if watches.len() == 0 %}
						<p class="text-gray-500 text-xs m-4 lowercase font-normal">
							No values watched yet. Click on values in the
							instruction or stack window (e.g. "v123",
							"ObjectId(456)") to get more details.
						</p>
					{% else %}
						<ul>
							{% for watch in watches %}
								{% match watch %}
								{% when Watch::VReg with (evreg) %}
									<li>call{{evreg.0.0}} v{{evreg.1.0}}</li>
								{% endmatch %}
							{% endfor %}
						</ul>
					{% endif %}
				</div>
			</div>

			<div id="stack-scroll-area" class="overflow-x-scroll divide-y px-4 py-2">
				{% for frame in core_dump.data.frames() %}
					{# Frames are visited top-to-bottom by this loop, whereas vm_result.call_id_stack is bottom-to-top #}
					{% let call_id = vm_result.call_id_stack[vm_result.call_id_stack.len() - loop.index] %}
					{% let hdr = frame.header() %}
					<div class="grid grid-cols-[2cm_1fr] gap-x-2 text-sm my-2">
						<div class='text-right'>Call ID:</div>
						<div>{{ call_id.0 }}</div>

						<div class='text-right'>Function:</div>
						<div>{{ hdr.fn_id.0 }}</div>
						
						<div class='text-right'>This:</div>
						<div>{{ "{:?}"|format(hdr.this) }}</div>
						<div class='text-right'>Return to:</div>
						<div>
							{{ "{:?}"|format(hdr.return_value_vreg) }} 
							@
							{{ "{:?}"|format(hdr.return_to_iid) }}
						</div>
						<div class="col-span-full flex place-content-center text-xs text-gray-500 space-x-4">
							<div>{{hdr.n_instrs}} instrs </div>
							<div>{{hdr.n_args}} args</div>
							<div>{{hdr.n_captures}} captures</div>
						</div>

						{% for item in frame.args() %}
						<div class="text-xs text-right">Arg <span class="font-mono">{{loop.index0}}</span></div>
						<div class="text-xs">{{ "{:?}"|format(item) }}</div>
						{% endfor %}

						{% for item in frame.results() %}
						<div
								class="text-xs text-right value read [&.highlighted]:bg-sky-500"
								data-mcjs-value="call{{ call_id.0 }}-v{{ loop.index0 }}">
							⬥Result <span class="font-mono">{{loop.index0}}</span>
						</div>
						<div class="text-xs">{{ "{:?}"|format(item) }}</div>
						{% endfor %}

						{% for item in frame.captures() %}
						<div class="text-xs text-right">Capture <span class="font-mono">{{loop.index0}}</span></div>
						<div class="text-xs">{{ "{:?}"|format(item) }}</div>
						{% endfor %}

					</div>
				{% endfor %}
			</div>

		{% when None %}
			<div class="p-4 h-full overflow-y-scroll col-span-2"> 
				<div class="bg-white rounded-md  p-4   bg-rose-50   ring-1   ring-rose-400   text-rose-900">
					No core dump available in this session!
				</div>
			</div>
		{% endmatch %}
	</div>

{% endblock %}

